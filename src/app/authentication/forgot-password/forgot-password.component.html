<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full rounded-xl shadow-[0_20px_50px_rgba(8,_112,_184,_0.1)] overflow-hidden bg-white" data-aos="fade-up">
      <!-- Header -->
      <div class="bg-gradient-to-r from-primary-700 to-primary-900 p-6 text-white">
        <div class="flex justify-center mb-4">
          <img src="/assets/blogo.png" alt="EMart.lk Logo" class="h-12 w-auto filter brightness-0 invert" />
        </div>
        <h1 class="text-2xl font-bold text-center">Reset Your Password</h1>
        <p class="text-center text-gray-100 mt-2">Follow the steps to recover your account access</p>
      </div>
      
      <!-- Progress Indicator -->
      <div class="px-6 pt-6">
        <div class="flex items-center justify-between mb-6">
          <div class="flex flex-col items-center">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium" 
                 [ngClass]="{'bg-primary-600': currentStep >= 1, 'bg-gray-300': currentStep < 1}">1</div>
            <span class="text-xs mt-1 text-gray-600">Identify</span>
          </div>
          <div class="flex-1 h-1 mx-2" [ngClass]="{'bg-primary-600': currentStep >= 2, 'bg-gray-300': currentStep < 2}"></div>
          <div class="flex flex-col items-center">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium"
                 [ngClass]="{'bg-primary-600': currentStep >= 2, 'bg-gray-300': currentStep < 2}">2</div>
            <span class="text-xs mt-1 text-gray-600">Verify</span>
          </div>
          <div class="flex-1 h-1 mx-2" [ngClass]="{'bg-primary-600': currentStep >= 3, 'bg-gray-300': currentStep < 3}"></div>
          <div class="flex flex-col items-center">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium"
                 [ngClass]="{'bg-primary-600': currentStep >= 3, 'bg-gray-300': currentStep < 3}">3</div>
            <span class="text-xs mt-1 text-gray-600">Reset</span>
          </div>
        </div>
      </div>
      
      <!-- Step 1: Identify Account -->
      <div class="p-6" *ngIf="currentStep === 1" data-aos="fade-right">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Find Your Account</h2>
        <p class="text-gray-600 mb-6">Please enter your information to search for your account.</p>
        
        <form [formGroup]="identifierForm" (ngSubmit)="verifyIdentifier()" class="space-y-5">
          <div>
            <label for="identifierType" class="block text-sm font-medium text-gray-700 mb-1">Identification Method</label>
            <p-dropdown 
              id="identifierType"
              formControlName="identifierType"
              [options]="identifierTypes"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
              [style]="{'width': '100%'}"
              placeholder="Select identification method">
            </p-dropdown>
          </div>
          
          <div>
            <label [for]="identifierForm.get('identifierType')?.value" class="block text-sm font-medium text-gray-700 mb-1">
              {{ identifierForm.get('identifierType')?.value === 'username' ? 'Username' : 
                 identifierForm.get('identifierType')?.value === 'email' ? 'Email Address' : 'Phone Number' }}
            </label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
                <i class="pi" [ngClass]="{
                  'pi-user': identifierForm.get('identifierType')?.value === 'username',
                  'pi-envelope': identifierForm.get('identifierType')?.value === 'email',
                  'pi-phone': identifierForm.get('identifierType')?.value === 'phone'
                }"></i>
              </span>
              <input
                [id]="identifierForm.get('identifierType')?.value"
                formControlName="identifierValue"
                pInputText
                class="w-full pl-10 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200"
                [placeholder]="identifierForm.get('identifierType')?.value === 'username' ? 'Enter your username' : 
                              identifierForm.get('identifierType')?.value === 'email' ? 'Enter your email address' : 'Enter your phone number'"
              />
            </div>
            <small
              *ngIf="identifierForm.get('identifierValue')?.invalid && identifierForm.get('identifierValue')?.touched"
              class="text-red-500 text-xs mt-1 flex items-center">
              <i class="pi pi-exclamation-circle mr-1"></i> This field is required
            </small>
          </div>
          
          <div class="flex items-center justify-between pt-2">
            <button
              type="button"
              pButton
              label="Back to Login"
              icon="pi pi-arrow-left"
              class="p-button-text p-button-sm"
              routerLink="/login">
            </button>
            
            <p-button
              type="submit"
              [loading]="loading"
              icon="pi pi-search"
              label="Search"
              styleClass="p-button-primary">
            </p-button>
          </div>
        </form>
      </div>
      
      <!-- Step 2: Select Verification Method -->
      <div class="p-6" *ngIf="currentStep === 2" data-aos="fade-right">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Verify Your Identity</h2>
        <p class="text-gray-600 mb-6">How would you like to receive the verification code?</p>
        
        <div class="space-y-4">
          <div class="border border-gray-200 rounded-lg p-4 hover:border-primary-500 hover:bg-primary-50 transition-colors duration-200 cursor-pointer"
               (click)="sendVerificationCode('email')">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
                <i class="pi pi-envelope text-lg"></i>
              </div>
              <div class="ml-4">
                <h3 class="text-sm font-medium text-gray-900">Email</h3>
                <p class="text-sm text-gray-500">{{ getMaskedInfo('email') }}</p>
              </div>
            </div>
          </div>
          
          <div class="border border-gray-200 rounded-lg p-4 hover:border-primary-500 hover:bg-primary-50 transition-colors duration-200 cursor-pointer"
               (click)="sendVerificationCode('phone')">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
                <i class="pi pi-mobile text-lg"></i>
              </div>
              <div class="ml-4">
                <h3 class="text-sm font-medium text-gray-900">SMS</h3>
                <p class="text-sm text-gray-500">{{ getMaskedInfo('phone') }}</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mt-6 pt-4 border-t border-gray-200">
          <button
            type="button"
            pButton
            label="Back"
            icon="pi pi-arrow-left"
            class="p-button-outlined p-button-sm"
            (click)="goBack()">
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- OTP Verification Dialog -->
  <p-dialog 
    [(visible)]="displayOtpDialog" 
    [modal]="true" 
    [draggable]="false" 
    [resizable]="false"
    [style]="{width: '400px'}"
    header="Verification Code"
    [closeOnEscape]="false"
    [closable]="false"
    styleClass="p-fluid">
    
    <div class="p-4">
      <div class="text-center mb-6">
        <div class="w-16 h-16 mx-auto rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
          <i class="pi pi-lock text-3xl"></i>
        </div>
        <h2 class="text-xl font-semibold mt-4">Enter Verification Code</h2>
        <p class="text-gray-600 mt-2">
          We've sent a 6-digit code to your {{ selectedContactMethod === 'email' ? 'email' : 'phone' }}.
          <br>Please enter it below.
        </p>
      </div>
      
      <form [formGroup]="otpForm" (ngSubmit)="verifyOTP()" class="space-y-4">
        <div>
          <label for="otp" class="block text-sm font-medium text-gray-700 mb-1">Verification Code</label>
          <p-inputMask
            id="otp"
            formControlName="otp"
            mask="999999"
            placeholder="Enter 6-digit code"
            styleClass="w-full"
            [style]="{'width': '100%'}">
          </p-inputMask>
          <small
            *ngIf="otpForm.get('otp')?.invalid && otpForm.get('otp')?.touched"
            class="text-red-500 text-xs mt-1 flex items-center">
            <i class="pi pi-exclamation-circle mr-1"></i> Please enter a valid 6-digit code
          </small>
        </div>
        
        <div class="text-center">
          <p class="text-sm text-gray-600 mb-2">
            Didn't receive the code?
            <button 
              type="button" 
              class="text-primary-600 hover:text-primary-800 font-medium"
              (click)="resendOTP()">
              Resend
            </button>
          </p>
        </div>
      </form>
    </div>
    
    <ng-template pTemplate="footer">
      <div class="flex justify-between">
        <p-button 
          label="Cancel" 
          icon="pi pi-times" 
          styleClass="p-button-text"
          (click)="displayOtpDialog = false">
        </p-button>
        <p-button 
          label="Verify" 
          icon="pi pi-check" 
          [loading]="loading"
          (click)="verifyOTP()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
  
  <!-- New Password Dialog -->
  <p-dialog 
    [(visible)]="displayNewPasswordDialog" 
    [modal]="true" 
    [draggable]="false" 
    [resizable]="false"
    [style]="{width: '450px'}"
    header="Reset Password"
    [closeOnEscape]="false"
    [closable]="false"
    styleClass="p-fluid">
    
    <div class="p-4">
      <div class="text-center mb-6">
        <div class="w-16 h-16 mx-auto rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
          <i class="pi pi-key text-3xl"></i>
        </div>
        <h2 class="text-xl font-semibold mt-4">Create New Password</h2>
        <p class="text-gray-600 mt-2">
          Your identity has been verified!<br>
          Set your new password below.
        </p>
      </div>
      
      <form [formGroup]="newPasswordForm" (ngSubmit)="resetPassword()" class="space-y-4">
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500 z-10">
              <i class="pi pi-lock"></i>
            </span>
            <p-password
              id="password"
              formControlName="password"
              [toggleMask]="true"
              styleClass="w-full"
              [feedback]="true"
              promptLabel="Create a strong password"
              weakLabel="Too simple"
              mediumLabel="Average complexity"
              strongLabel="Complex password"
              inputStyleClass="w-full pl-10 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200"
              placeholder="Enter new password">
            </p-password>
          </div>
          <small
            *ngIf="newPasswordForm.get('password')?.invalid && newPasswordForm.get('password')?.touched"
            class="text-red-500 text-xs mt-1 flex items-center">
            <i class="pi pi-exclamation-circle mr-1"></i> Password must be at least 8 characters
          </small>
        </div>
        
        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500 z-10">
              <i class="pi pi-lock"></i>
            </span>
            <p-password
              id="confirmPassword"
              formControlName="confirmPassword"
              [toggleMask]="true"
              [feedback]="false"
              styleClass="w-full"
              inputStyleClass="w-full pl-10 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200"
            placeholder="Confirm new password">
          </p-password>
        </div>
        <small
          *ngIf="newPasswordForm.get('confirmPassword')?.touched && newPasswordForm.hasError('mismatch')"
          class="text-red-500 text-xs mt-1 flex items-center">
          <i class="pi pi-exclamation-circle mr-1"></i> Passwords do not match
        </small>
      </div>
      
      <div class="mt-2">
        <div class="flex items-center text-sm text-gray-600">
          <i class="pi pi-info-circle mr-2 text-primary-500"></i>
          <span>Your password must be at least 8 characters and include a mix of letters, numbers, and symbols.</span>
        </div>
      </div>
    </form>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between">
      <p-button 
        label="Cancel" 
        icon="pi pi-times" 
        styleClass="p-button-text"
        (click)="displayNewPasswordDialog = false">
      </p-button>
      <p-button 
        label="Reset Password" 
        icon="pi pi-check" 
        [loading]="loading"
        (click)="resetPassword()">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

<p-toast position="top-right"></p-toast>
