<div class="dashboard-container p-4" data-aos="fade-in">
  <!-- Loading overlay -->
  <div *ngIf="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <p-progressSpinner styleClass="w-12 h-12" strokeWidth="4"></p-progressSpinner>
  </div>
  
  <!-- Breadcrumb -->
  <div class="mb-6">
    <p-breadcrumb [model]="items" [home]="home"></p-breadcrumb>
  </div>
  
  <!-- Product Management Header Card -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8" data-aos="fade-up" data-aos-delay="100">
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">Product Management</h1>
        <p class="text-gray-600 mt-1">Manage your inventory and product listings</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="relative">
          <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">
            <i class="pi pi-search"></i>
          </span>
          <input
            type="text"
            pInputText
            placeholder="Search products..."
            class="pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 w-full"
          />
        </div>
        <p-button
          icon="pi pi-refresh"
          (onClick)="Refresh()"
          styleClass="p-button-rounded p-button-outlined"
          pTooltip="Refresh products"
          tooltipPosition="top"
        ></p-button>
        <p-button
          (click)="visible = true; productForm.reset()"
          label="Add Product"
          icon="pi pi-plus"
          styleClass="p-button-primary"
          pTooltip="Add new product"
          tooltipPosition="top"
        ></p-button>
      </div>
    </div>
  </div>
  
  <!-- Products Table Card -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8" data-aos="fade-up" data-aos-delay="200">
    <div class="overflow-x-auto">
      <p-table
        [value]="fetchingItems"
        [paginator]="true"
        [rows]="5"
        [rowsPerPageOptions]="[5,10,25]"
        styleClass="p-datatable-sm p-datatable-gridlines"
        [tableStyle]="{'min-width': '960px'}"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="id" style="width: 5%">ID <p-sortIcon field="id"></p-sortIcon></th>
            <th style="width: 10%">Image</th>
            <th pSortableColumn="name" style="width: 15%">Name <p-sortIcon field="name"></p-sortIcon></th>
            <th pSortableColumn="description" style="width: 20%">Description <p-sortIcon field="description"></p-sortIcon></th>
            <th pSortableColumn="unitPrice" style="width: 8%">Price <p-sortIcon field="unitPrice"></p-sortIcon></th>
            <th pSortableColumn="discount" style="width: 8%">Discount <p-sortIcon field="discount"></p-sortIcon></th>
            <th pSortableColumn="itemCount" style="width: 8%">Quantity <p-sortIcon field="itemCount"></p-sortIcon></th>
            <th pSortableColumn="reOrderLevel" style="width: 8%">Re-Order <p-sortIcon field="reOrderLevel"></p-sortIcon></th>
            <th pSortableColumn="catagoryName" style="width: 10%">Category <p-sortIcon field="catagoryName"></p-sortIcon></th>
            <th style="width: 8%">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{ item.id }}</td>
            <td>
              <img
                [src]="item.image"
                [alt]="item.name"
                width="80"
                class="shadow-sm rounded-md object-cover h-16"
              />
            </td>
            <td>{{ item.name }}</td>
            <td>
              <div
                pTooltip="{{ item.description }}"
                tooltipPosition="top"
                class="line-clamp-2 overflow-hidden"
                style="max-width: 200px;">
                {{ item.description | slice:0:30 }}{{ item.description.length > 30 ? '...' : '' }}
              </div>
            </td>
            <td>{{ item.unitPrice | currency : "LKR" : "symbol" }}</td>
            <td>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ item.discount > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' }}">
                {{ (item.discount || 0.0) + "%" }}
              </span>
            </td>
            <td>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{
                item.itemCount === 0 ? 'bg-red-100 text-red-800' :
                item.itemCount <= item.reOrderLevel ? 'bg-yellow-100 text-yellow-800' :
                'bg-blue-100 text-blue-800'
              }}">
                {{ item.itemCount || 0 }}
              </span>
            </td>
            <td>{{ item.reOrderLevel || 0 }}</td>
            <td>
              <div class="flex flex-col">
                <span class="font-medium">{{ item.catagoryName }}</span>
                <span class="text-xs text-gray-500">{{ item.subCategoryName }}</span>
              </div>
            </td>
            <td>
              <div class="flex gap-2">
                <p-button
                  icon="pi pi-file-edit"
                  styleClass="p-button-rounded p-button-success p-button-sm"
                  (onClick)="fetchProduct(item.id)"
                  pTooltip="Edit product"
                  tooltipPosition="top"
                ></p-button>
                <p-button
                  icon="pi pi-trash"
                  styleClass="p-button-rounded p-button-danger p-button-sm"
                  (onClick)="deleteProduct(item.id)"
                  pTooltip="Delete product"
                  tooltipPosition="top"
                ></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="10" class="text-center py-6">
              <div class="flex flex-col items-center">
                <i class="pi pi-inbox text-6xl text-gray-300 mb-4"></i>
                <span class="text-gray-500">No products found</span>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<!-- Add/Edit Product Dialog -->
<p-dialog
  [header]="isUpdate ? 'Update Product' : 'Add New Product'"
  [(visible)]="visible"
  [modal]="true"
  [style]="{width: '650px'}"
  [breakpoints]="{'960px': '90vw'}"
  [draggable]="false"
  [resizable]="false"
  styleClass="p-fluid">
  
  <p class="text-gray-600 mb-6">
    {{ isUpdate ? "Update the product details below" : "Fill in the product details below" }}
  </p>
  
  <form [formGroup]="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Category -->
    <div class="field">
      <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
<p-dropdown
  #categoryDropdownn
  id="category"
  [options]="fetchingCategories"
  optionLabel="name"
  optionValue="id"
  formControlName="category"
  placeholder="Select a category"
  (onChange)="onCategorySelectionChange($event)"
  [showClear]="true"
  styleClass="w-full"
  [filter]="true"
  filterBy="name"
  [virtualScroll]="true"
  [virtualScrollItemSize]="38"
></p-dropdown>





      <small *ngIf="productForm.get('category')?.invalid && productForm.get('category')?.touched" class="text-red-500 flex items-center mt-1">
        <i class="pi pi-exclamation-circle mr-1"></i> Category is required
      </small>
    </div>
    
    <!-- SubCategory -->
    <div class="field">
      <label for="subCategory" class="block text-sm font-medium text-gray-700 mb-1">Sub Category</label>
      <p-dropdown
        id="subCategory"
        [options]="fetchingSubCategories"
        optionLabel="name"
        optionValue="id"
        formControlName="subCategory"
        placeholder="Select a sub category"
        [showClear]="true"
        styleClass="w-full"
        [filter]="true"
        filterBy="name"
        [filterPlaceholder]="'Search sub category...'"
        [virtualScroll]="true"
        [virtualScrollItemSize]="38"
        [disabled]="!selectedCategory"
      ></p-dropdown>
      <small *ngIf="productForm.get('subCategory')?.invalid && productForm.get('subCategory')?.touched" class="text-red-500 flex items-center mt-1">
        <i class="pi pi-exclamation-circle mr-1"></i> Sub Category is required
      </small>
    </div>
    
    <!-- Name -->
    <div class="field md:col-span-2">
      <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
      <div class="p-input-icon-left w-full">
        <i class="pi pi-tag"></i>
        <input
          pInputText
          id="name"
          type="text"
          formControlName="name"
          class="w-full pl-8"
          placeholder="Enter product name"
        />
      </div>
      <small *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched" class="text-red-500 flex items-center mt-1">
        <i class="pi pi-exclamation-circle mr-1"></i> Name is required
      </small>
    </div>
    
    <!-- Unit Price -->
    <div class="field">
      <label for="unitPrice" class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
      <p-inputNumber
        id="unitPrice"
        formControlName="unitPrice"
        mode="currency"
        currency="LKR"
        locale="en-US"
        placeholder="0.00"
      ></p-inputNumber>
      <small *ngIf="productForm.get('unitPrice')?.invalid && productForm.get('unitPrice')?.touched" class="text-red-500 flex items-center mt-1">
        <i class="pi pi-exclamation-circle mr-1"></i> Price is required
      </small>
    </div>
    
    <!-- Quantity -->
    <div class="field">
      <label for="itemCount" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
      <p-inputNumber
        id="itemCount"
        formControlName="itemCount"
        [showButtons]="true"
        [min]="0"
        placeholder="0"
      ></p-inputNumber>
      <small *ngIf="productForm.get('itemCount')?.invalid && productForm.get('itemCount')?.touched" class="text-red-500 flex items-center mt-1">
        <i class="pi pi-exclamation-circle mr-1"></i> Quantity is required
      </small>
    </div>
    
    <!-- Discount -->
    <div class="field">
      <label for="discount" class="block text-sm font-medium text-gray-700 mb-1">Discount (%)</label>
      <p-inputNumber
        id="discount"
        formControlName="discount"
        [showButtons]="true"
        [min]="0"
        [max]="100"
        suffix="%"
        placeholder="0%"
      ></p-inputNumber>
      <small *ngIf="productForm.get('discount')?.invalid && productForm.get('discount')?.touched" class="text-red-500 flex items-center mt-1">
        <i class="pi pi-exclamation-circle mr-1"></i> Discount is required
      </small>
    </div>
    
    <!-- Re-Order Level -->
    <div class="field">
      <label for="reOrderLevel" class="block text-sm font-medium text-gray-700 mb-1">Re-Order Level</label>
      <p-inputNumber
        id="reOrderLevel"
        formControlName="reOrderLevel"
        [showButtons]="true"
        [min]="0"
        placeholder="0"
      ></p-inputNumber>
      <small *ngIf="productForm.get('reOrderLevel')?.invalid && productForm.get('reOrderLevel')?.touched" class="text-red-500 flex items-center mt-1">
        <i class="pi pi-exclamation-circle mr-1"></i> Re-order level is required
      </small>
    </div>
    
    <!-- Description -->
    <div class="field md:col-span-2">
      <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
      <div class="p-input-icon-left w-full">
        <i class="pi pi-info-circle"></i>
        <textarea
          pInputTextarea
          id="description"
          formControlName="description"
          rows="3"
          class="w-full pl-8"
          placeholder="Enter product description"
        ></textarea>
      </div>
      <small *ngIf="productForm.get('description')?.invalid && productForm.get('description')?.touched" class="text-red-500 flex items-center mt-1">
        <i class="pi pi-exclamation-circle mr-1"></i> Description is required
      </small>
    </div>
    
    <!-- Image -->
    <div class="field md:col-span-2">
      <label for="image" class="block text-sm font-medium text-gray-700 mb-1">Product Image</label>
      <div class="flex items-center space-x-4">
        <div class="flex-shrink-0">
          <p-fileUpload
            [customUpload]="true"
            (uploadHandler)="onFileSelected($event)"
            accept="image/*"
            [auto]="true"
            chooseLabel="Select Image"
            [multiple]="false"
            [showCancelButton]="false"
            [showUploadButton]="false"
            styleClass="p-button-sm"
          ></p-fileUpload>
        </div>
        <div class="flex-grow">
          <div *ngIf="previewImage" class="flex items-center gap-4">
            <img [src]="previewImage" alt="Preview" class="h-20 w-20 object-cover rounded-md shadow-md border border-gray-200" />
            <div class="text-sm text-gray-500">
              <p>Image selected</p>
              <p-button
                icon="pi pi-times"
                styleClass="p-button-text p-button-rounded p-button-sm text-red-500"
                (onClick)="clearImage()"
                pTooltip="Remove image"
                tooltipPosition="top"
              ></p-button>
            </div>
          </div>
          <div *ngIf="!previewImage" class="text-sm text-gray-500">
            No image selected. Please upload a product image.
          </div>
        </div>
      </div>
      <small *ngIf="productForm.get('image')?.invalid && productForm.get('image')?.touched" class="text-red-500 flex items-center mt-1">
        <i class="pi pi-exclamation-circle mr-1"></i> Image is required
      </small>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button
        label="Cancel"
        icon="pi pi-times"
        (click)="cancelDialog()"
        styleClass="p-button-text"
      ></p-button>
      <p-button
        *ngIf="isUpdate"
        label="Update"
        icon="pi pi-check"
        (click)="updateProduct()"
        [disabled]="productForm.invalid"
        [loading]="submitting"
      ></p-button>
      <p-button
        *ngIf="!isUpdate"
        label="Save"
        icon="pi pi-check"
        (click)="addProduct()"
        [disabled]="productForm.invalid"
        [loading]="submitting"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Confirmation Dialog for Delete -->
<p-confirmDialog
  header="Confirm Deletion"
  icon="pi pi-exclamation-triangle"
  acceptButtonStyleClass="p-button-danger"
  rejectButtonStyleClass="p-button-text"
  acceptLabel="Delete"
  rejectLabel="Cancel"></p-confirmDialog>

<!-- Toast Notifications -->
<!-- <p-toast position="top-right"></p-toast> -->

